# Лабораторна 8

### Тема: Впровадження Наскрізного Моніторингу Мікросервісної Архітектури (Go, Prometheus, Grafana)

-----

### Мета Роботи

Метою було **успішне розгортання повнофункціональної системи моніторингу**, що включає інтеграцію метрик Prometheus у мікросервіси на Go, налаштування Docker Compose для середовища (PostgreSQL, Redis, API, Worker, Prometheus, Grafana) та створення інформативного дашборду.

-----

## 1\. Інтеграція Метрик у Мікросервіси (Go Code Snippets)

Інтеграція бібліотеки `github.com/prometheus/client_golang/prometheus` була **успішно завершена** для обох сервісів.

### A. API Gateway (`api/main.go`)

API Gateway був налаштований на експорт HTTP-метрик на стандартному шляху `/metrics` через порт `8080`.

**Реалізований код:**

У функції, що налаштовує маршрути (`setupRoutes()`), був доданий необхідний обробник:

```go
// Фрагмент, успішно доданий до setupRoutes()
// ...
// Налаштування стандартного маршруту для метрик Prometheus
router.Handle("/metrics", promhttp.Handler()).Methods("GET") 
// ...
```

### B. Worker Service (`worker/main.go`)

Worker Service було оснащено **бізнес-логічними метриками** для відстеження кількості та тривалості обробки завдань.

**1. Оголошення та Реєстрація Метрик:**

На початку `worker/main.go` **були оголошені та зареєстровані** дві ключові метрики: `CounterVec` для підрахунку завдань за статусом та `Histogram` для часу обробки.

```go
// Ініціалізація лічильника (Counter) для успішних/невдалих завдань
var jobsProcessed = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Name: "worker_jobs_processed_total",
        Help: "Total number of jobs processed by action (e.g., grayscale, blur) and status.",
    },
    []string{"action", "status"}, // status: completed, failed
)

// Ініціалізація гістограми (Histogram) для часу обробки
var jobDuration = prometheus.NewHistogram(prometheus.HistogramOpts{
    Name:    "worker_job_duration_seconds",
    Help:    "Histogram of job processing duration in seconds.",
    Buckets: prometheus.DefBuckets, 
})

func init() {
    // Реєстрація метрик була виконана
    prometheus.MustRegister(jobsProcessed)
    prometheus.MustRegister(jobDuration)
}
```

**2. Вимірювання:**

У функції `processJob` **була реалізована логіка** для вимірювання часу та інкрементування лічильників:

```go
// На початку обробки було зафіксовано час
startTime := time.Now()

// ... логіка обробки зображення була успішно виконана ...

// Після успішного завершення
duration := time.Since(startTime).Seconds()
jobDuration.Observe(duration)
jobsProcessed.WithLabelValues(action, "completed").Inc()
```

**3. Експозиція Метрик (Worker):**

Для експорту метрик Worker **був запущений окремий HTTP-сервер** на внутрішньому **порті 9091**, що підтверджує його незалежну здатність моніторингу:

```go
// Функція, запущена у go-рутині в main()
func startMetricsServer() {
    // Використовувався окремий порт 9091 для метрик
    http.Handle("/metrics", promhttp.Handler())
    log.Fatal(http.ListenAndServe(":9091", nil)) 
}
```

-----

## 2\. Конфігурація Середовища (Docker Compose)

### A. Файл `docker-compose.yml`

Файл `docker-compose.yml` **був оновлений** для включення всіх необхідних компонентів та забезпечення коректної мережевої взаємодії. Це включало додавання сервісів `postgres`, `prometheus` та `grafana`, а також налаштування залежностей та відкриття порту `9091` для Worker:

```yaml
version: '3.8'

services:
  # 1. СЕРВІС ЧЕРГИ ТА КЕШУ
  redis:
    image: redis:6-alpine
    container_name: redis_queue_cache
    networks:
      - internal_network
    command: redis-server --appendonly yes 

  # 2. СЕРВІС СТІЙКОГО СХОВИЩА (POSTGRESQL)
  postgres:
    image: postgres:15-alpine
    container_name: postgres_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: jobs_db
    volumes:
      - postgres_data:/var/lib/postgresql/data # Стійкий Volume для БД
    networks:
      - internal_network

  # 3. СЕРВІС API-ШЛЮЗУ 
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: image_api_gateway
    ports:
      - "8080:8080"
    volumes:
      - ./storage:/app/storage
    depends_on:
      - redis
      - postgres 
    networks:
      - internal_network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      # ЗМІННІ СЕРЕДОВИЩА ДЛЯ POSTGRES
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DBNAME=jobs_db

  # 4. СЕРВІС ОБРОБКИ 
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: image_worker_service
    volumes:
      - ./storage:/app/storage
    depends_on:
      - redis
      - postgres 
    networks:
      - internal_network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      # ЗМІННІ СЕРЕДОВИЩА ДЛЯ POSTGRES
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DBNAME=jobs_db
      
# 5. СЕРВІС ВІЗУАЛІЗАЦІЇ (Grafana)
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - internal_network
    depends_on:
      - prometheus
networks:
  internal_network:
    driver: bridge

volumes:
  postgres_data: # Визначення Volume для Postgre
```

### B. Тестування

1.  Уся система **була успішно запущена** командою `docker compose up --build -d`.

2.  **Перевірка Prometheus UI:** Доступ до http://localhost:9091 був успішним.

3.  **Перевірка цілей (Targets):** На сторінці **Status -\> Targets** було підтверджено, що **api-gateway** та **worker-service** коректно прослуховуються, маючи статус **UP**.

4.  Виконання тестових завдань та перевірка запиту `worker_jobs_processed_total` підтвердили **надходження бізнес-метрик**.

-----

## 3\. Побудова Дашборду Grafana

### A. Налаштування Grafana

1.  **Доступ:** До Grafana було отримано доступ через http://localhost:3000.
2.  **Джерело даних:** **Prometheus був успішно доданий** як джерело даних. Було використано внутрішню URL-адресу `http://prometheus:9091`, і тест підключення **був пройдений успішно**.


## Dashboards у Grafana

Нижче залиште місце для скріншотів, які демонструють успішне виконання лабораторної роботи:

### 1\. Скріншот: Prometheus Targets (http://localhost:9091/targets)

<img width="1920" height="932" alt="image" src="https://github.com/user-attachments/assets/6acff602-47d3-4a24-9f16-26f91d35df9b" />


### 2\. Скріншот: Grafana Data Sources Configuration

<img width="1920" height="941" alt="image" src="https://github.com/user-attachments/assets/87711ba0-2ee6-4bd0-8851-9ae55b582fa6" />


### 3\. Скріншот: Grafana Dashboard

<img width="1920" height="972" alt="image" src="https://github.com/user-attachments/assets/a5da5e73-85d9-4662-812a-17c29eba0c4b" />

<img width="1920" height="925" alt="image" src="https://github.com/user-attachments/assets/5ac70c49-7348-4466-9560-3bf40d6d361e" />

