# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ 8

### –¢–µ–º–∞: –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –ù–∞—Å–∫—Ä—ñ–∑–Ω–æ–≥–æ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–Ω–æ—ó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ (Go, Prometheus, Grafana)

-----

### üéØ –ú–µ—Ç–∞ –†–æ–±–æ—Ç–∏

–ú–µ—Ç–æ—é –±—É–ª–æ **—É—Å–ø—ñ—à–Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É**, —â–æ –≤–∫–ª—é—á–∞—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –º–µ—Ç—Ä–∏–∫ Prometheus —É –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ –Ω–∞ Go, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Docker Compose –¥–ª—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (PostgreSQL, Redis, API, Worker, Prometheus, Grafana) —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥—É.

-----

## 1\. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –ú–µ—Ç—Ä–∏–∫ —É –ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ (Go Code Snippets)

–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ `github.com/prometheus/client_golang/prometheus` –±—É–ª–∞ **—É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞** –¥–ª—è –æ–±–æ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤.

### A. API Gateway (`api/main.go`)

API Gateway –±—É–≤ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç HTTP-–º–µ—Ç—Ä–∏–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —à–ª—è—Ö—É `/metrics` —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç `8080`.

**–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥:**

–£ —Ñ—É–Ω–∫—Ü—ñ—ó, —â–æ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î –º–∞—Ä—à—Ä—É—Ç–∏ (`setupRoutes()`), –±—É–≤ –¥–æ–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫:

```go
// –§—Ä–∞–≥–º–µ–Ω—Ç, —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∏–π –¥–æ setupRoutes()
// ...
// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –¥–ª—è –º–µ—Ç—Ä–∏–∫ Prometheus
router.Handle("/metrics", promhttp.Handler()).Methods("GET") 
// ...
```

### B. Worker Service (`worker/main.go`)

Worker Service –±—É–ª–æ –æ—Å–Ω–∞—â–µ–Ω–æ **–±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ—á–Ω–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏** –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–∞ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –æ–±—Ä–æ–±–∫–∏ –∑–∞–≤–¥–∞–Ω—å.

**1. –û–≥–æ–ª–æ—à–µ–Ω–Ω—è —Ç–∞ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –ú–µ—Ç—Ä–∏–∫:**

–ù–∞ –ø–æ—á–∞—Ç–∫—É `worker/main.go` **–±—É–ª–∏ –æ–≥–æ–ª–æ—à–µ–Ω—ñ —Ç–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ** –¥–≤—ñ –∫–ª—é—á–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏: `CounterVec` –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∑–∞–≤–¥–∞–Ω—å –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º —Ç–∞ `Histogram` –¥–ª—è —á–∞—Å—É –æ–±—Ä–æ–±–∫–∏.

```go
// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (Counter) –¥–ª—è —É—Å–ø—ñ—à–Ω–∏—Ö/–Ω–µ–≤–¥–∞–ª–∏—Ö –∑–∞–≤–¥–∞–Ω—å
var jobsProcessed = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Name: "worker_jobs_processed_total",
        Help: "Total number of jobs processed by action (e.g., grayscale, blur) and status.",
    },
    []string{"action", "status"}, // status: completed, failed
)

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—ñ—Å—Ç–æ–≥—Ä–∞–º–∏ (Histogram) –¥–ª—è —á–∞—Å—É –æ–±—Ä–æ–±–∫–∏
var jobDuration = prometheus.NewHistogram(prometheus.HistogramOpts{
    Name:    "worker_job_duration_seconds",
    Help:    "Histogram of job processing duration in seconds.",
    Buckets: prometheus.DefBuckets, 
})

func init() {
    // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –º–µ—Ç—Ä–∏–∫ –±—É–ª–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞
    prometheus.MustRegister(jobsProcessed)
    prometheus.MustRegister(jobDuration)
}
```

**2. –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è:**

–£ —Ñ—É–Ω–∫—Ü—ñ—ó `processJob` **–±—É–ª–∞ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞** –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É —Ç–∞ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤:

```go
// –ù–∞ –ø–æ—á–∞—Ç–∫—É –æ–±—Ä–æ–±–∫–∏ –±—É–ª–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ —á–∞—Å
startTime := time.Now()

// ... –ª–æ–≥—ñ–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—É–ª–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–∞ ...

// –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
duration := time.Since(startTime).Seconds()
jobDuration.Observe(duration)
jobsProcessed.WithLabelValues(action, "completed").Inc()
```

**3. –ï–∫—Å–ø–æ–∑–∏—Ü—ñ—è –ú–µ—Ç—Ä–∏–∫ (Worker):**

–î–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É –º–µ—Ç—Ä–∏–∫ Worker **–±—É–≤ –∑–∞–ø—É—â–µ–Ω–∏–π –æ–∫—Ä–µ–º–∏–π HTTP-—Å–µ—Ä–≤–µ—Ä** –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–º—É **–ø–æ—Ä—Ç—ñ 9091**, —â–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –π–æ–≥–æ –Ω–µ–∑–∞–ª–µ–∂–Ω—É –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É:

```go
// –§—É–Ω–∫—Ü—ñ—è, –∑–∞–ø—É—â–µ–Ω–∞ —É go-—Ä—É—Ç–∏–Ω—ñ –≤ main()
func startMetricsServer() {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è –æ–∫—Ä–µ–º–∏–π –ø–æ—Ä—Ç 9091 –¥–ª—è –º–µ—Ç—Ä–∏–∫
    http.Handle("/metrics", promhttp.Handler())
    log.Fatal(http.ListenAndServe(":9091", nil)) 
}
```

-----

## 2\. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –°–µ—Ä–µ–¥–æ–≤–∏—â–∞ (Docker Compose)

### A. –§–∞–π–ª `docker-compose.yml`

–§–∞–π–ª `docker-compose.yml` **–±—É–≤ –æ–Ω–æ–≤–ª–µ–Ω–∏–π** –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è –≤—Å—ñ—Ö –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó –º–µ—Ä–µ–∂–µ–≤–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó. –¶–µ –≤–∫–ª—é—á–∞–ª–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—ñ–≤ `postgres`, `prometheus` —Ç–∞ `grafana`, –∞ —Ç–∞–∫–æ–∂ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —Ç–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ—Ä—Ç—É `9091` –¥–ª—è Worker:

```yaml
version: '3.8'

services:
  # 1. –°–ï–†–í–Ü–° –ß–ï–†–ì–ò –¢–ê –ö–ï–®–£
  redis:
    image: redis:6-alpine
    container_name: redis_queue_cache
    networks:
      - internal_network
    command: redis-server --appendonly yes 

  # 2. –°–ï–†–í–Ü–° –°–¢–Ü–ô–ö–û–ì–û –°–•–û–í–ò–©–ê (POSTGRESQL)
  postgres:
    image: postgres:15-alpine
    container_name: postgres_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: jobs_db
    volumes:
      - postgres_data:/var/lib/postgresql/data # –°—Ç—ñ–π–∫–∏–π Volume –¥–ª—è –ë–î
    networks:
      - internal_network

  # 3. –°–ï–†–í–Ü–° API-–®–õ–Æ–ó–£ 
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: image_api_gateway
    ports:
      - "8080:8080"
    volumes:
      - ./storage:/app/storage
    depends_on:
      - redis
      - postgres 
    networks:
      - internal_network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      # –ó–ú–Ü–ù–ù–Ü –°–ï–†–ï–î–û–í–ò–©–ê –î–õ–Ø POSTGRES
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DBNAME=jobs_db

  # 4. –°–ï–†–í–Ü–° –û–ë–†–û–ë–ö–ò 
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: image_worker_service
    volumes:
      - ./storage:/app/storage
    depends_on:
      - redis
      - postgres 
    networks:
      - internal_network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      # –ó–ú–Ü–ù–ù–Ü –°–ï–†–ï–î–û–í–ò–©–ê –î–õ–Ø POSTGRES
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DBNAME=jobs_db
      
# 5. –°–ï–†–í–Ü–° –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á (Grafana)
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - internal_network
    depends_on:
      - prometheus
networks:
  internal_network:
    driver: bridge

volumes:
  postgres_data: # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è Volume –¥–ª—è Postgre
```

### B. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

1.  –£—Å—è —Å–∏—Å—Ç–µ–º–∞ **–±—É–ª–∞ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞** –∫–æ–º–∞–Ω–¥–æ—é `docker compose up --build -d`.

2.  **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Prometheus UI:** –î–æ—Å—Ç—É–ø –¥–æ http://localhost:9091 –±—É–≤ —É—Å–ø—ñ—à–Ω–∏–º.

3.  **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª–µ–π (Targets):** –ù–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ **Status -\> Targets** –±—É–ª–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ, —â–æ **api-gateway** —Ç–∞ **worker-service** –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É—é—Ç—å—Å—è, –º–∞—é—á–∏ —Å—Ç–∞—Ç—É—Å **UP**.

4.  –í–∏–∫–æ–Ω–∞–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –∑–∞–≤–¥–∞–Ω—å —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø–∏—Ç—É `worker_jobs_processed_total` –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ **–Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫**.

-----

## 3\. –ü–æ–±—É–¥–æ–≤–∞ –î–∞—à–±–æ—Ä–¥—É Grafana

### A. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Grafana

1.  **–î–æ—Å—Ç—É–ø:** –î–æ Grafana –±—É–ª–æ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ http://localhost:3000.
2.  **–î–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö:** **Prometheus –±—É–≤ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∏–π** —è–∫ –¥–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö. –ë—É–ª–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é URL-–∞–¥—Ä–µ—Å—É `http://prometheus:9091`, —ñ —Ç–µ—Å—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è **–±—É–≤ –ø—Ä–æ–π–¥–µ–Ω–∏–π —É—Å–ø—ñ—à–Ω–æ**.


## Dashboards —É Grafana

–ù–∏–∂—á–µ –∑–∞–ª–∏—à—Ç–µ –º—ñ—Å—Ü–µ –¥–ª—è —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ–≤, —è–∫—ñ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—é—Ç—å —É—Å–ø—ñ—à–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏:

### 1\. –°–∫—Ä—ñ–Ω—à–æ—Ç: Prometheus Targets (http://localhost:9091/targets)

<img width="1920" height="932" alt="image" src="https://github.com/user-attachments/assets/6acff602-47d3-4a24-9f16-26f91d35df9b" />


### 2\. –°–∫—Ä—ñ–Ω—à–æ—Ç: Grafana Data Sources Configuration

<img width="1920" height="941" alt="image" src="https://github.com/user-attachments/assets/87711ba0-2ee6-4bd0-8851-9ae55b582fa6" />


### 3\. –°–∫—Ä—ñ–Ω—à–æ—Ç: Grafana Dashboard

<img width="1920" height="972" alt="image" src="https://github.com/user-attachments/assets/a5da5e73-85d9-4662-812a-17c29eba0c4b" />

<img width="1920" height="925" alt="image" src="https://github.com/user-attachments/assets/5ac70c49-7348-4466-9560-3bf40d6d361e" />

